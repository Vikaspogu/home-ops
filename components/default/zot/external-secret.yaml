---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: zot
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: zot
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        config.yaml: |
          http:
            address: 0.0.0.0
            port: 5000
            externalUrl: https://zot.${CLUSTER_DOMAIN}
            compat: [docker2s2]
            accessControl:
              adminPolicy:
                groups: [Authentik Admins]
                actions: [create, read, update, delete, detectManifestCollision]
              repositories:
                "**":
                  defaultPolicy: [read]
                "pub/**":
                  defaultPolicy: [read]
                  anonymousPolicy: [read]
            auth:
              failDelay: 3
              openid:
                providers:
                  oidc:
                    issuer: https://id.{{.CLUSTER_DOMAIN}}/application/o/zot/
                    scopes: [openid, profile, email, groups]
                    clientid: "{{ .CLIENT_ID }}"
                    clientsecret: "{{ .CLIENT_SECRET }}"
          log:
            level: debug
          extensions:
            ui:
              enable: true
            search:
              enable: true
            metrics:
              enable: true
              prometheus:
                path: /metrics
            mgmt:
              enable: true
          storage:
            rootDirectory: /var/lib/registry
            remoteCache: true
            cacheDriver:
              name: redis
              url: redis://valkey.default.svc.cluster.local:6379
            dedupe: true
            gc: true
            gcDelay: "1h"
            gcInterval: "24h"
            retention:
              dryRun: false
              delay: "24h"
              policies:
                - repositories:
                    - "**"
                  deleteReferrers: true
                  deleteUntagged: true
                  keepTags:
                    - mostRecentlyPushedCount: 5
                      mostRecentlyPulledCount: 5
                      pulledWithin: "720h"
                      pushedWithin: "720h"
  dataFrom:
    - extract:
        key: zot
    - extract:
        key: talos
