---
controllers:
  app:
    annotations:
      reloader.stakater.com/auto: "true"
    pod:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
    initContainers:
      install-tools:
        image:
          repository: ghcr.io/openclaw/openclaw
          tag: 2026.2.13@sha256:c6528e72dbeeebca3c928e6d6109ef991d249b4939a093c7f9e28708d24fc059
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
        command:
          - /bin/sh
          - -c
          - |
            set -e
            mkdir -p /home/node/.local/bin /home/node/.local/go

            echo "Starting tool installation..."

            # Install gh CLI if not present on PVC
            if [ ! -f /home/node/.local/bin/gh ]; then
              echo "Installing gh CLI..."
              cd /tmp
              curl -fsSL https://github.com/cli/cli/releases/download/v2.61.0/gh_2.61.0_linux_amd64.tar.gz -o gh.tar.gz
              tar xzf gh.tar.gz
              cp gh_2.61.0_linux_amd64/bin/gh /home/node/.local/bin/
              rm -rf gh.tar.gz gh_2.61.0_linux_amd64
            fi

            # Install Go if not present on PVC
            if [ ! -f /home/node/.local/go/bin/go ]; then
              echo "Installing Go..."
              cd /tmp
              curl -fsSL https://go.dev/dl/go1.23.5.linux-amd64.tar.gz -o go.tar.gz
              tar xzf go.tar.gz
              mv go /home/node/.local/
              rm -rf go.tar.gz
            fi

            # Install Homebrew if not present on PVC
            if [ ! -f /home/node/.local/homebrew/bin/brew ]; then
              echo "Installing Homebrew..."
              export HOMEBREW_PREFIX=/home/node/.local/homebrew
              export HOMEBREW_CELLAR=/home/node/.local/homebrew/Cellar
              export HOMEBREW_REPOSITORY=/home/node/.local/homebrew
              mkdir -p $HOMEBREW_PREFIX
              cd /tmp
              git clone --depth 1 https://github.com/Homebrew/brew $HOMEBREW_PREFIX
            fi

            # Check if pip is available (either standalone or via python3 -m pip)
            set +e
            if command -v pip3 >/dev/null 2>&1 || command -v pip >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
              echo "pip is available"
            else
              echo "Installing pip..."
              cd /tmp
              curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
              python3 get-pip.py --user --no-warn-script-location --break-system-packages || \
              python3 get-pip.py --user --no-warn-script-location || \
              echo "pip install skipped (use python3 -m pip instead)"
              rm -f get-pip.py
            fi
            set -e

            echo "Tool installation complete"
            mkdir -p /home/node/.openclaw
            echo "Init container completed successfully"
        resources:
          requests:
            cpu: 10m
            memory: 256Mi
          limits:
            memory: 1Gi
    containers:
      app:
        image:
          repository: ghcr.io/openclaw/openclaw
          tag: 2026.2.13
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
        env:
          TZ: "America/New_York"
          BROWSER_WS_ENDPOINT: "ws://localhost:9222"
          GOPATH: /home/node/go
          HOME: &homepath /home/node
          HOMEBREW_CELLAR: /home/node/.local/homebrew/Cellar
          HOMEBREW_PREFIX: /home/node/.local/homebrew
          HOMEBREW_REPOSITORY: /home/node/.local/homebrew
          PATH: /home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          PIP_BREAK_SYSTEM_PACKAGES: "1"
          TERM: xterm-256color
        envFrom:
          - secretRef:
              name: openclaw-secret
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 18789
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 10
              failureThreshold: 5
          readiness: *probes
          startup:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 18789
              initialDelaySeconds: 10
              periodSeconds: 5
              timeoutSeconds: 10
              failureThreshold: 30
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 2Gi

service:
  app:
    ports:
      http:
        port: 18789

persistence:
  # Main data directory (~/.openclaw)
  data:
    enabled: true
    existingClaim: openclaw
    globalMounts:
      - path: *homepath
  # Mount openclaw.json from secret
  config:
    enabled: true
    type: secret
    name: openclaw-config-json
    defaultMode: 0600
    globalMounts:
      - path: /home/node/.openclaw/openclaw.json
        subPath: openclaw.json
        readOnly: true
