---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mo
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: mo-secret
    template:
      engineVersion: v2
      data:
        INFERENCE_HUB_MODEL: "{{ .INFERENCE_HUB_MODEL }}"
        INFERENCE_HUB_BASE_URL: "{{ .INFERENCE_HUB_BASE_URL }}"
        API_KEY: "{{ .API_KEY }}"
        EMBEDDING_MODEL: "{{.EMBEDDING_MODEL}}"
        SLACK_BOT_TOKEN: "{{.MO_BOT_TOKEN}}"
        SLACK_APP_TOKEN: "{{.MO_APP_TOKEN}}"
        GH_TOKEN: "{{.K8S_TOKEN}}"
        NEXTCLOUD_URL: "{{.CAL_DAV_URL}}"
        NEXTCLOUD_USER: "{{.NC_USER}}"
        NEXTCLOUD_PASSWORD: "{{.NC_PASSWORD}}"
        DIGEST_CHANNEL_ID: "{{.DIGEST_CHANNEL_ID}}"
        GITEA_TOKEN: "{{.MO_TOKEN}}"
        GITEA_URL: "https://gitea.omv.${CLUSTER_DOMAIN}"
        ALERTS_CHANNEL_ID: "{{.ALERTS_CHANNEL_ID}}"
        ALERT_NOTIFY_USER_ID: "{{.ALERT_NOTIFY_USER_ID}}"

        DATABASE_URL: |-
          postgres://{{ .MO_POSTGRES_USER }}:{{ .MO_POSTGRES_PASS }}@postgres17-rw.default.svc.cluster.local/mo
        # Postgres Init
        INIT_POSTGRES_DBNAME: mo
        INIT_POSTGRES_HOST: postgres17-rw.default.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .MO_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .MO_POSTGRES_PASS }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
  dataFrom:
    - extract:
        key: inference-hub
    - extract:
        key: mo
    - extract:
        key: cloudnative-pg
    - extract:
        key: Slack
    - extract:
        key: nextcloud
    - extract:
        key: Github
    - extract:
        key: gitea
