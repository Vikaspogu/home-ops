---
controllers:
  app:
    pod:
      securityContext:
        runAsUser: 999
        runAsGroup: 999
      annotations:
        reloader.stakater.com/auto: "true"
    containers:
      app:
        image:
          repository: docker.io/1password/connect-api
          tag: 1.7.4
        env:
          OP_BUS_PORT: "11220"
          OP_BUS_PEERS: "localhost:11221"
          OP_HTTP_PORT: &port 8080
          OP_SESSION:
            valueFrom:
              secretKeyRef:
                name: onepassword-connect-secret
                key: onepassword-credentials.json
        resources:
          requests:
            cpu: 5m
            memory: 10Mi
          limits:
            memory: 100Mi
      sync:
        image:
          repository: docker.io/1password/connect-sync
          tag: 1.7.4@sha256:27e7ec47e1ad8eaa2f54764fa0736954a5119d0155dea3c923c481c89c5f964c
        env:
          - name: OP_SESSION
            valueFrom:
              secretKeyRef:
                name: onepassword-connect-secret
                key: onepassword-credentials.json
          - name: OP_HTTP_PORT
            value: &port 8081
          - name: OP_BUS_PORT
            value: "11221"
          - name: OP_BUS_PEERS
            value: "localhost:11220"
service:
  app:
    ports:
      http:
        port: 8080

probes:
  liveness:
    enabled: true
    custom: true
    spec:
      httpGet:
        path: /heartbeat
        port: *port
      initialDelaySeconds: 15
      periodSeconds: 30
      failureThreshold: 3
  readiness:
    enabled: true
    custom: true
    spec:
      httpGet:
        path: /health
        port: *port
      initialDelaySeconds: 15
  startup:
    enabled: false

persistence:
  shared:
    enabled: true
    type: emptyDir
    globalMounts:
      - path: /home/opuser/.op/data
