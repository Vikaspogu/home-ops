{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    "docker:enableMajor",
    ":disableRateLimiting",
    ":dependencyDashboard",
    ":semanticCommits",
    ":automergeDigest",
    ":automergeBranch"
  ],
  "platform": "github",
  "username": "renovate[bot]",
  "repositories": ["vikaspogu/home-ops"],
  "onboarding": false,
  "requireConfig": "optional",
  "suppressNotifications": ["prIgnoreNotification"],
  "rebaseWhen": "conflicted",
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "ðŸ¤– Renovate Dashboard",
  "commitMessageTopic": "{{depName}}",
  "commitMessageExtra": "to {{newVersion}}",
  "commitMessageSuffix": "",
  "timezone": "America/New_York",
  "ignorePaths": ["**/*.sops.*"],
  "helm-values": {
    "fileMatch": ["components/.+/values\\.ya?ml$"]
  },
  "kubernetes": {
    "fileMatch": ["components/.+\\.ya?ml$", "clusters/.+\\.ya?ml$"],
    "ignorePaths": [
      "components/common/helm-secrets-private-keys.sops.yaml",
      "components/external-secrets/onepassword-connect/secrets.sops.yaml"
    ]
  },
  "regexManagers": [
    {
      "description": "Process CRD dependencies in bootstrap script",
      "fileMatch": ["scripts/bootstrap-apps\\.sh$"],
      "matchStrings": [
        "# renovate: datasource=(?<datasource>.*?) depName=(?<depName>.*?)\\s+.*?/(?<currentValue>v?[0-9\\.]+)/"
      ],
      "datasourceTemplate": "{{datasource}}"
    },
    {
      "description": "Process Helm chart dependencies in kustomization files",
      "fileMatch": ["components/.+/kustomization\\.ya?ml$"],
      "matchStrings": [
        "- name: (?<depName>.*)\\s+repo: (?<registryUrl>.*)\\s+version: [\"']?(?<currentValue>.*?)[\"']?"
      ],
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process Helm chart versions in helmfile",
      "fileMatch": ["clusters/.+/helmfile\\.ya?ml$"],
      "matchStrings": [
        "- name: (?<depName>.*)\\s+.*?chart: (?<packageName>.*)\\s+version: (?<currentValue>.*)"
      ],
      "registryUrlTemplate": "{{#if registryUrl}}{{registryUrl}}{{else}}https://charts.helm.sh/stable{{/if}}",
      "datasourceTemplate": "helm"
    },
    {
      "description": "Process container images in YAML files",
      "fileMatch": ["components/.+\\.ya?ml$", "clusters/.+\\.ya?ml$"],
      "matchStrings": [
        "image: [\"']?(?<depName>.*?):(?<currentValue>.*?)[\"']?\\s"
      ],
      "datasourceTemplate": "docker"
    },
    {
      "description": "Process Talos versions",
      "fileMatch": ["clusters/.+/talconfig\\.ya?ml$"],
      "matchStrings": [
        "talosVersion: [\"']?(?<currentValue>v[0-9\\.]+)[\"']?"
      ],
      "depNameTemplate": "siderolabs/talos",
      "datasourceTemplate": "github-releases"
    },
    {
      "description": "Process Kubernetes versions",
      "fileMatch": ["clusters/.+/talconfig\\.ya?ml$"],
      "matchStrings": [
        "kubernetesVersion: [\"']?(?<currentValue>v[0-9\\.]+)[\"']?"
      ],
      "depNameTemplate": "kubernetes/kubernetes",
      "datasourceTemplate": "github-releases"
    }
  ],
  "packageRules": [
    // version pinning
    {
      "description": ["Pin browserless/chromium to v2.18.0"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/browserless/chromium"],
      "allowedVersions": ["v2.18.0"]
    },
    {
      "description": ["Pin gotify/server to 2.6.3"],
      "matchDatasources": ["docker"],
      "matchPackageNames": ["ghcr.io/gotify/server"],
      "allowedVersions": ["2.6.3"]
    },
    {
      description: ["Pin viaductoss/ksops to v4.3.3"],
      matchDatasources: ["docker"],
      matchPackageNames: ["viaductoss/ksops"],
      allowedVersions: ["v4.3.3"],
    },
    {
      "description": "Loose versioning for non-semver packages",
      "matchDatasources": ["docker"],
      "versioning": "loose",
      "matchPackagePatterns": ["ghcr.io/bjw-s-labs/helm"]
    },
    {
      "description": "Group Cilium updates",
      "groupName": "Cilium",
      "matchPackagePatterns": ["cilium"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group ArgoCD updates",
      "groupName": "ArgoCD",
      "matchPackagePatterns": ["argo.*cd", "argoproj"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group cert-manager updates",
      "groupName": "cert-manager",
      "matchPackagePatterns": ["cert-manager"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group external-secrets updates",
      "groupName": "external-secrets",
      "matchPackagePatterns": ["external-secrets"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group Longhorn updates",
      "groupName": "Longhorn",
      "matchPackagePatterns": ["longhorn"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group Traefik updates",
      "groupName": "Traefik",
      "matchPackagePatterns": ["traefik"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group Envoy Gateway updates",
      "groupName": "Envoy Gateway",
      "matchPackagePatterns": ["envoy.*gateway", "gateway.*helm"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group 1Password Connect updates",
      "groupName": "1Password Connect",
      "matchPackagePatterns": ["1password", "onepassword"],
      "matchDatasources": ["docker", "helm"]
    },
    {
      "description": "Group app-template updates",
      "groupName": "app-template",
      "matchPackagePatterns": ["app-template", "bjw-s-labs"],
      "matchDatasources": ["helm"]
    },
    {
      "description": "Separate PRs for major updates",
      "matchUpdateTypes": ["major","minor", "patch"],
    },
    {
      "description": "Custom versioning for Talos",
      "matchPackageNames": ["siderolabs/talos"],
      "versioning": "semver-coerced"
    },
    {
      "description": "Ignore development and beta versions",
      "matchPackagePatterns": [".*"],
      "allowedVersions": "!/.*[-\\.]?(alpha|beta|rc|dev|unstable)/"
    },
    {
      "description": "Pin GitHub Actions to exact versions",
      "matchManagers": ["github-actions"],
      "pinDigests": true
    }
  ],
  "assignees": ["@vikaspogu"],
  "reviewers": ["@vikaspogu"]
}
