name: PR Webhook Notifications

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  send-webhooks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files_yaml: |
            omv:
              - 'clusters/omv/**'
              - 'components/**'

      - name: Send cluster webhooks
        id: send-cluster-webhooks
        env:
          # Webhook URLs from secrets
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}

          # Changed files information
          OMV_CHANGED_FILES: ${{ steps.changed-files.outputs.omv_all_changed_files }}
          OMV_ANY_CHANGED: ${{ steps.changed-files.outputs.omv_any_changed }}

          # GitHub event information
          GITHUB_EVENT_ACTION: ${{ github.event.action }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_EVENT_NUMBER: ${{ github.event.number }}

          # Pull Request information (only what's used in payload)
          PR: ${{ github.event.pull_request }}

          # Sender information (used in pull_request.user and sender)
          SENDER: ${{ github.event.sender}}

          # Repository information (used in repository and pull_request.head.repo)
          REPO: ${{ github.event.repository }}

          # GitHub webhook headers
          X_GITHUB_EVENT: ${{ github.event_name }}
          X_GITHUB_DELIVERY: ${{ github.run_id }}
          X_HUB_SIGNATURE_256: ${{ github.event.head_commit.id }}
          X_GITHUB_HOOK_ID: ${{ github.event.repository.hooks_url }}
          X_GITHUB_HOOK_INSTALLATION_TARGET_ID: ${{ github.event.installation.id }}
          X_GITHUB_HOOK_INSTALLATION_TARGET_TYPE: ${{ github.event.installation.target_type }}
        run: |
          # Debug: Show critical GitHub context
          echo "🔍 GitHub Event Debug Info:"
          echo "  Event Name: ${{ github.event_name }}"
          echo "  Event Action: '${{ github.event.action }}'"
          echo "  Repository: ${{ github.repository }}"
          echo "  PR Number: ${{ github.event.number }}"
          echo "  Run ID: ${{ github.run_id }}"

          # Use the webhook script from the scripts directory with summary generation
          ./scripts/send-webhooks.sh --results-file /tmp/webhook-results.txt --summary --verbose

          # Read results for the next step if needed
          if [[ -f /tmp/webhook-results.txt ]]; then
            cat /tmp/webhook-results.txt >> $GITHUB_OUTPUT
          else
            echo "webhook_results=error:no_results_file" >> $GITHUB_OUTPUT
          fi

      - name: Workflow completed
        run: |
          echo "✅ Webhook processing completed. Check the summary above for details."
